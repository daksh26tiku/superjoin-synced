<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>System Health Dashboard</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: linear-gradient(135deg, #0f0f0f 0%, #1a1a1a 100%);
      color: #f5f5f5;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      min-height: 100vh;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      background: rgba(26, 26, 26, 0.8);
      border: 1px solid #2a2a2a;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      font-size: 28px;
      font-weight: 700;
    }

    .status-badge {
      display: flex;
      align-items: center;
      gap: 8px;
      background: #1a1a1a;
      padding: 8px 16px;
      border-radius: 20px;
      border: 1px solid #2a2a2a;
    }

    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #22c55e;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.5;
      }
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .card {
      background: rgba(26, 26, 26, 0.8);
      border: 1px solid #2a2a2a;
      border-radius: 12px;
      padding: 24px;
      transition: border-color 0.3s;
    }

    .card:hover {
      border-color: #22c55e;
    }

    .card-label {
      color: #888;
      font-size: 14px;
      margin-bottom: 8px;
    }

    .card-value {
      font-size: 32px;
      font-weight: 700;
      color: #22c55e;
    }

    .card-subtext {
      color: #666;
      font-size: 12px;
      margin-top: 4px;
    }

    .feed-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 24px;
      margin-bottom: 24px;
    }

    .feed-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .event {
      background: rgba(17, 17, 17, 0.5);
      border: 1px solid #2a2a2a;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
      display: flex;
      align-items: start;
      gap: 12px;
    }

    .event-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #22c55e;
      margin-top: 6px;
      flex-shrink: 0;
    }

    .event-content {
      flex: 1;
    }

    .event-row {
      font-weight: 600;
      font-size: 14px;
    }

    .event-time {
      color: #666;
      font-size: 12px;
      margin-top: 4px;
    }

    .table-container {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead {
      background: rgba(17, 17, 17, 0.5);
    }

    th {
      padding: 12px;
      text-align: left;
      font-size: 14px;
      color: #888;
      font-weight: 600;
    }

    td {
      padding: 12px;
      border-top: 1px solid #2a2a2a;
    }

    code {
      background: #1a1a1a;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 13px;
    }

    .badge {
      background: rgba(34, 197, 94, 0.1);
      color: #22c55e;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 13px;
    }

    .loading {
      text-align: center;
      padding: 60px;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #2a2a2a;
      border-top-color: #22c55e;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .btn {
      background: #22c55e;
      color: #0e0e0e;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn:hover {
      background: #16a34a;
      transform: translateY(-1px);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn:disabled {
      background: #2a2a2a;
      color: #666;
      cursor: not-allowed;
    }

    .btn-blue {
      background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%);
      color: white;
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
      width: 100%;
      justify-content: center;
    }

    .btn-blue:hover {
      background: linear-gradient(135deg, #4338ca 0%, #4f46e5 100%);
      transform: translateY(-1px);
    }

    .btn-blue:active {
      transform: translateY(0);
    }

    .btn-blue:disabled {
      background: #2a2a2a;
      color: #666;
      cursor: not-allowed;
    }

    .btn-link {
      background: transparent;
      color: #22c55e;
      padding: 12px 20px;
      border: 1px solid #22c55e;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 8px;
      width: 100%;
      justify-content: center;
    }

    .btn-link:hover {
      background: rgba(34, 197, 94, 0.1);
      transform: translateY(-1px);
    }

    .btn-link:active {
      transform: translateY(0);
    }

    .actions-card {
      background: rgba(26, 26, 26, 0.6);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    .actions-card:hover {
      border-color: rgba(79, 70, 229, 0.5);
    }

    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #1a1a1a;
      border: 1px solid #22c55e;
      padding: 16px 24px;
      border-radius: 8px;
      z-index: 1000;
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }

      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
  </style>
</head>

<body>
  <!-- API Base URL pointing to Render backend -->
  <script>
    window.API_BASE_URL = 'https://superjoin-synced-sgtu.onrender.com';
  </script>

  <div id="app"></div>

  <script>
    (function () {
      // Configuration - Point to your backend API
      // This will be injected by Vercel via environment variable
      const API_BASE_URL = window.API_BASE_URL || 'https://superjoin-synced-sgtu.onrender.com';

      const app = document.getElementById('app');
      let healthData = null;

      function render() {
        if (!healthData) {
          app.innerHTML = `
            <div class="container">
              <div class="loading">
                <div class="spinner"></div>
                <p style="color: #888;">Loading dashboard...</p>
              </div>
            </div>
          `;
          return;
        }

        const incomingEvents = (healthData.feed || [])
          .filter(e => e.type === 'SHEET_TO_DB')
          .slice(0, 8);

        const outgoingEvents = (healthData.feed || [])
          .filter(e => e.type === 'DB_TO_SHEET')
          .slice(0, 8);

        const tables = healthData.registry || [];

        app.innerHTML = `
          <div class="container">
            <div class="header">
              <div>
                <h1>üöÄ Superjoin Sync Engine</h1>
                <p style="color: #888; font-size: 14px; margin-top: 4px;">Real-time 2-way sync between Google Sheets & MySQL</p>
              </div>
              <div style="display: flex; gap: 12px; align-items: center;">
                <button class="btn" id="testBtn">üß™ Test Sync</button>
                <div class="status-badge">
                  <div class="status-dot"></div>
                  <span>${healthData.status === 'online' ? 'Live' : 'Offline'}</span>
                </div>
              </div>
            </div>

            <div class="grid">
              <div class="card">
                <div class="card-label">Sync Status</div>
                <div class="card-value">${healthData.status === 'online' ? 'Online' : 'Offline'}</div>
              </div>
              <div class="card">
                <div class="card-label">Active Workers</div>
                <div class="card-value">${healthData.activeWorkers}</div>
                <div class="card-subtext">Redis Queue Active</div>
              </div>
              <div class="card">
                <div class="card-label">Last Sync</div>
                <div class="card-value" style="font-size: 20px;">${healthData.lastSync}</div>
              </div>
              <div class="card">
                <div class="card-label">Total Rows Tracked</div>
                <div class="card-value">${(healthData.totalRows || 0).toLocaleString()}</div>
              </div>
              
              <!-- Open Google Sheet Card -->
              <div class="card" style="display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; transition: all 0.2s; border: 1px solid rgba(52,211,153,0.3);" onclick="window.open('https://docs.google.com/spreadsheets/d/1g5RiCOQshml9wdsKsiyuGKC5gOe3UZr39smC1L-SfIY/edit?pli=1&gid=0#gid=0', '_blank')">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#34d399" stroke-width="2" style="margin-bottom: 8px;">
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                  <line x1="9" y1="3" x2="9" y2="21"></line>
                  <line x1="15" y1="3" x2="15" y2="21"></line>
                  <line x1="3" y1="9" x2="21" y2="9"></line>
                  <line x1="3" y1="15" x2="21" y2="15"></line>
                </svg>
                <div class="card-label" style="color: #34d399;">Open Google Sheet</div>
              </div>
            </div>

            <h2 style="font-size: 24px; font-weight: 700; margin-bottom: 16px;">üì° Live Event Feed</h2>
            <div class="feed-grid">
              <div class="card">
                <div class="feed-title">üì• Incoming (Sheet ‚Üí DB)</div>
                ${incomingEvents.length === 0 ?
            '<p style="color: #666; text-align: center; padding: 40px;">Waiting for events...</p>' :
            incomingEvents.map(e => `
                    <div class="event">
                      <div class="event-dot"></div>
                      <div class="event-content">
                        <div class="event-row">${(typeof e.message === 'object' ? e.message.message : e.message) || 'Row Update'}</div>
                        <div class="event-time">${new Date(e.timestamp).toLocaleString()}</div>
                      </div>
                    </div>
                  `).join('')
          }
              </div>
              <div class="card">
                <div class="feed-title">üì§ Outgoing (DB ‚Üí Sheet)</div>
                ${outgoingEvents.length === 0 ?
            '<p style="color: #666; text-align: center; padding: 40px;">Waiting for events...</p>' :
            outgoingEvents.map(e => `
                    <div class="event">
                      <div class="event-dot"></div>
                      <div class="event-content">
                        <div class="event-row">${(typeof e.message === 'object' ? e.message.message : e.message) || 'Row Update'}</div>
                        <div class="event-time">${new Date(e.timestamp).toLocaleString()}</div>
                      </div>
                    </div>
                  `).join('')
          }
              </div>
            </div>

            <!-- Manual Test Lab Section -->
            <h2 style="font-size: 24px; font-weight: 700; margin-bottom: 16px; display: flex; align-items: center; gap: 12px;">
              üß™ Manual Test Lab
              <span style="font-size: 12px; color: #888; font-weight: 400; background: rgba(255,255,255,0.05); padding: 4px 12px; border-radius: 12px;">Developer Tools</span>
            </h2>
            <div style="margin-bottom: 24px;">
              <!-- Form: Simulate DB Update (DB -> Sheet) -->
              <div class="actions-card">
                <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#6366f1" stroke-width="2">
                    <ellipse cx="12" cy="5" rx="9" ry="3"></ellipse>
                    <path d="M3 5v14a9 3 0 0 0 18 0V5"></path>
                    <path d="M3 12a9 3 0 0 0 18 0"></path>
                  </svg>
                  Simulate DB Update
                  <span style="font-size: 11px; color: #888; font-weight: 400;">DB ‚Üí Sheet</span>
                </h3>
                <div style="display: flex; flex-direction: column; gap: 12px;">
                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div>
                      <label style="font-size: 12px; color: #888; display: block; margin-bottom: 4px;">Table Name</label>
                      <select id="dbTableName" 
                        style="width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 10px 14px; color: white; font-size: 14px; outline: none; transition: border-color 0.2s; cursor: pointer;"
                        onfocus="this.style.borderColor='rgba(99,102,241,0.5)'" onblur="this.style.borderColor='rgba(255,255,255,0.1)'">
                        <option value="" style="background: #1a1a1a;">Auto-select first table</option>
                        ${tables.map(t => `<option value="${t.mysql_table_name}" style="background: #1a1a1a;">${t.mysql_table_name}</option>`).join('')}
                      </select>
                    </div>
                    <div>
                      <label style="font-size: 12px; color: #888; display: block; margin-bottom: 4px;">Row ID (_sync_row_id)</label>
                      <input type="number" id="dbRowId" placeholder="Leave empty for INSERT" min="1"
                        style="width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 10px 14px; color: white; font-size: 14px; outline: none; transition: border-color 0.2s;"
                        onfocus="this.style.borderColor='rgba(99,102,241,0.5)'" onblur="this.style.borderColor='rgba(255,255,255,0.1)'"
                      />
                    </div>
                  </div>
                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div>
                      <label style="font-size: 12px; color: #888; display: block; margin-bottom: 4px;">Column</label>
                      <select id="dbColName" 
                        style="width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 10px 14px; color: white; font-size: 14px; outline: none; transition: border-color 0.2s; cursor: pointer;">
                        <option value="" style="background: #1a1a1a;">Auto-select first column</option>
                      </select>
                    </div>
                    <div>
                      <label style="font-size: 12px; color: #888; display: block; margin-bottom: 4px;">New Value</label>
                      <input type="text" id="dbColValue" placeholder="New value..."
                        style="width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 10px 14px; color: white; font-size: 14px; outline: none; transition: border-color 0.2s;"
                      />
                    </div>
                  </div>
                  <button id="manualDbBtn" 
                    style="background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%); color: white; padding: 12px 20px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 8px; justify-content: center; margin-top: 4px;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <ellipse cx="12" cy="5" rx="9" ry="3"></ellipse>
                      <path d="M3 5v14a9 3 0 0 0 18 0V5"></path>
                    </svg>
                    Execute SQL Update
                  </button>
                </div>
              </div>
            </div>

            <div class="card">
              <h2 style="font-size: 20px; font-weight: 700; margin-bottom: 16px;">üìä Dynamic Table Registry</h2>
              <p style="color: #888; font-size: 14px; margin-bottom: 16px;">Sheet to MySQL table mapping</p>
              <div class="table-container">
                <table>
                  <thead>
                    <tr>
                      <th>Google Sheet</th>
                      <th>MySQL Table</th>
                      <th style="text-align: right;">Created</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${tables.length === 0 ?
            '<tr><td colspan="3" style="text-align: center; color: #666; padding: 40px;">No tables registered yet</td></tr>' :
            tables.map(t => `
                        <tr>
                          <td><code>${t.sheet_name}</code></td>
                          <td><code>${t.mysql_table_name}</code></td>
                          <td style="text-align: right;"><span class="badge">${new Date(t.created_at).toLocaleDateString()}</span></td>
                        </tr>
                      `).join('')
          }
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        `;

        // Attach event listeners after DOM is built
        attachEventListeners();
      }

      // Attach all event listeners (called after render to avoid CSP issues with inline onclick)
      function attachEventListeners() {
        // Header Test Sync button
        const testBtn = document.getElementById('testBtn');
        if (testBtn) {
          testBtn.onclick = simulateDbChange;
        }

        // Quick Actions buttons
        const simulateBtn = document.getElementById('simulateBtn');
        if (simulateBtn) {
          simulateBtn.onclick = simulateDbUpdate;
        }

        const webhookBtn = document.getElementById('webhookBtn');
        if (webhookBtn) {
          webhookBtn.onclick = simulateWebhook;
        }

        const openSheetBtn = document.getElementById('openSheetBtn');
        if (openSheetBtn) {
          openSheetBtn.onclick = openGoogleSheet;
        }

        // Manual Test Lab buttons
        const manualWebhookBtn = document.getElementById('manualWebhookBtn');
        if (manualWebhookBtn) {
          manualWebhookBtn.onclick = triggerManualWebhook;
        }

        const manualDbBtn = document.getElementById('manualDbBtn');
        if (manualDbBtn) {
          manualDbBtn.onclick = triggerManualDbUpdate;
        }

        // Load columns when table is selected
        const dbTableName = document.getElementById('dbTableName');
        if (dbTableName) {
          dbTableName.onchange = loadColumnsForTable;
        }
      }

      // Load columns from API when table is selected
      async function loadColumnsForTable() {
        const tableSelect = document.getElementById('dbTableName');
        const columnSelect = document.getElementById('dbColName');
        if (!tableSelect || !columnSelect) return;

        const tableName = tableSelect.value;
        if (!tableName) {
          columnSelect.innerHTML = '<option value="" style="background: #1a1a1a;">Auto-select first column</option>';
          return;
        }

        try {
          const res = await fetch(`${API_BASE_URL}/api/tables/${encodeURIComponent(tableName)}/columns`);
          const data = await res.json();

          if (data.success && data.columns) {
            columnSelect.innerHTML = '<option value="" style="background: #1a1a1a;">Auto-select first column</option>' +
              data.columns.map(c => `<option value="${c}" style="background: #1a1a1a;">${c}</option>`).join('');
          }
        } catch (err) {
          console.error('Failed to load columns:', err);
        }
      }

      async function fetchData() {
        // Save input values before re-render
        const savedInputs = {
          webhookSheetName: document.getElementById('webhookSheetName')?.value || '',
          webhookRow: document.getElementById('webhookRow')?.value || '',
          webhookValue: document.getElementById('webhookValue')?.value || '',
          dbTableName: document.getElementById('dbTableName')?.value || '',
          dbRowId: document.getElementById('dbRowId')?.value || '',
          dbColName: document.getElementById('dbColName')?.value || '',
          dbColValue: document.getElementById('dbColValue')?.value || '',
        };

        try {
          const res = await fetch(`${API_BASE_URL}/api/health-dashboard`);
          if (res.ok) {
            healthData = await res.json();
          } else {
            throw new Error('API returned ' + res.status);
          }
        } catch (err) {
          console.log('Using mock data:', err.message);
          healthData = {
            status: 'online',
            activeWorkers: 3,
            lastSync: '5 seconds ago',
            totalRows: 12847,
            feed: [
              { type: 'SHEET_TO_DB', message: 'Row 42 updated', timestamp: new Date().toISOString() },
              { type: 'DB_TO_SHEET', message: 'Row 15 synced', timestamp: new Date().toISOString() }
            ],
            registry: [
              { sheet_name: 'Customers', sheet_id: '1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgvE2upms', mysql_table_name: 'customers_main', created_at: new Date().toISOString() },
              { sheet_name: 'Orders', sheet_id: '1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgvE2upms', mysql_table_name: 'orders_data', created_at: new Date().toISOString() }
            ]
          };
        }
        render();

        // Restore input values after re-render
        if (savedInputs.webhookSheetName) {
          const el = document.getElementById('webhookSheetName');
          if (el) el.value = savedInputs.webhookSheetName;
        }
        if (savedInputs.webhookRow) {
          const el = document.getElementById('webhookRow');
          if (el) el.value = savedInputs.webhookRow;
        }
        if (savedInputs.webhookValue) {
          const el = document.getElementById('webhookValue');
          if (el) el.value = savedInputs.webhookValue;
        }
        if (savedInputs.dbTableName) {
          const el = document.getElementById('dbTableName');
          if (el) el.value = savedInputs.dbTableName;
        }
        if (savedInputs.dbRowId) {
          const el = document.getElementById('dbRowId');
          if (el) el.value = savedInputs.dbRowId;
        }
        if (savedInputs.dbColName) {
          const el = document.getElementById('dbColName');
          if (el) el.value = savedInputs.dbColName;
        }
        if (savedInputs.dbColValue) {
          const el = document.getElementById('dbColValue');
          if (el) el.value = savedInputs.dbColValue;
        }
      }

      // Simulate Database Update Function (from Quick Actions)
      window.simulateDbUpdate = async function () {
        const btn = document.getElementById('simulateBtn');
        if (!btn) return;

        btn.disabled = true;
        btn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="spinner" style="animation: spin 1s linear infinite;"><circle cx="12" cy="12" r="10"></circle></svg> Triggering...';

        try {
          const res = await fetch(`${API_BASE_URL}/api/test/simulate-db-change`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          });

          const data = await res.json();

          if (data.success) {
            showToast(`‚úÖ ${data.message}`, 'success');
            setTimeout(() => fetchData(), 500);
          } else {
            showToast(`‚ùå ${data.message}`, 'error');
          }
        } catch (err) {
          showToast(`‚ùå Failed to simulate: ${err.message}`, 'error');
        } finally {
          btn.disabled = false;
          btn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><ellipse cx="12" cy="5" rx="9" ry="3"></ellipse><path d="M3 5v14a9 3 0 0 0 18 0V5"></path><path d="M3 12a9 3 0 0 0 18 0"></path></svg> Simulate Database Update';
        }
      };

      // Simulate Webhook Function
      window.simulateWebhook = async function () {
        const btn = document.getElementById('webhookBtn');
        if (!btn) return;

        btn.disabled = true;
        btn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="spinner" style="animation: spin 1s linear infinite;"><circle cx="12" cy="12" r="10"></circle></svg> Triggering...';

        try {
          const res = await fetch(`${API_BASE_URL}/api/test/simulate-webhook`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          });

          const data = await res.json();

          if (data.success) {
            showToast(`‚úÖ ${data.message}`, 'success');
            setTimeout(() => fetchData(), 500);
          } else {
            showToast(`‚ùå ${data.message}`, 'error');
          }
        } catch (err) {
          showToast(`‚ùå Failed to simulate webhook: ${err.message}`, 'error');
        } finally {
          btn.disabled = false;
          btn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"></path></svg> Simulate Sheet Webhook';
        }
      };

      // Manual Webhook Trigger (from Test Lab form)
      window.triggerManualWebhook = async function () {
        const btn = document.getElementById('manualWebhookBtn');
        if (!btn) return;

        const sheetName = document.getElementById('webhookSheetName')?.value || '';
        const row = parseInt(document.getElementById('webhookRow')?.value) || null;
        const value = document.getElementById('webhookValue')?.value || '';

        btn.disabled = true;
        btn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite;"><circle cx="12" cy="12" r="10"></circle></svg> Triggering...';

        try {
          const payload = {};
          if (sheetName) payload.sheetName = sheetName;
          if (row) payload.row = row;
          if (value) payload.value = value;

          const res = await fetch(`${API_BASE_URL}/api/test/simulate-webhook`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          const data = await res.json();

          if (data.success) {
            showToast(`‚úÖ ${data.message}`, 'success');
            setTimeout(() => fetchData(), 500);
          } else {
            showToast(`‚ùå ${data.message}`, 'error');
          }
        } catch (err) {
          showToast(`‚ùå Failed to trigger webhook: ${err.message}`, 'error');
        } finally {
          btn.disabled = false;
          btn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"></path></svg> Trigger Webhook';
        }
      };

      // Manual DB Update (from Test Lab form)
      window.triggerManualDbUpdate = async function () {
        const btn = document.getElementById('manualDbBtn');
        if (!btn) return;

        const tableName = document.getElementById('dbTableName')?.value || '';
        const rowId = parseInt(document.getElementById('dbRowId')?.value) || null;
        const colName = document.getElementById('dbColName')?.value || '';
        const colValue = document.getElementById('dbColValue')?.value || '';

        btn.disabled = true;
        btn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite;"><circle cx="12" cy="12" r="10"></circle></svg> Executing...';

        try {
          const payload = {};
          if (tableName) payload.tableName = tableName;
          if (rowId) payload.rowId = rowId;
          if (colName) payload.colName = colName;
          if (colValue) payload.colValue = colValue;

          const res = await fetch(`${API_BASE_URL}/api/test/simulate-db-change`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          const data = await res.json();

          if (data.success) {
            const opType = data.details?.operation === 'UPDATE' ? 'Updated' : 'Inserted';
            showToast(`‚úÖ ${opType}: ${data.message}`, 'success');
            setTimeout(() => fetchData(), 500);
          } else {
            showToast(`‚ùå ${data.message}`, 'error');
          }
        } catch (err) {
          showToast(`‚ùå Failed to execute DB update: ${err.message}`, 'error');
        } finally {
          btn.disabled = false;
          btn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><ellipse cx="12" cy="5" rx="9" ry="3"></ellipse><path d="M3 5v14a9 3 0 0 0 18 0V5"></path></svg> Execute SQL Update';
        }
      };

      // Open Google Sheet Function
      window.openGoogleSheet = function (event) {
        event.preventDefault();

        if (!healthData || !healthData.registry || healthData.registry.length === 0) {
          showToast('‚ùå No Google Sheets registered yet', 'error');
          return;
        }

        const firstSheet = healthData.registry[0];
        if (!firstSheet.sheet_id) {
          showToast('‚ùå Sheet ID not available', 'error');
          return;
        }

        const sheetUrl = `https://docs.google.com/spreadsheets/d/${firstSheet.sheet_id}/edit`;
        window.open(sheetUrl, '_blank');
        showToast(`üìä Opening ${firstSheet.sheet_name}...`, 'success');
      };

      // Test Sync Function (from header button)
      window.simulateDbChange = async function () {
        const btn = document.getElementById('testBtn');
        if (!btn) return;

        btn.disabled = true;
        btn.textContent = '‚è≥ Testing...';

        try {
          const res = await fetch('/api/test/simulate-db-change', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          });

          const data = await res.json();

          if (data.success) {
            showToast(`‚úÖ ${data.message}`, 'success');
            setTimeout(() => fetchData(), 500);
          } else {
            showToast(`‚ùå ${data.message}`, 'error');
          }
        } catch (err) {
          showToast(`‚ùå Failed to simulate: ${err.message}`, 'error');
        } finally {
          btn.disabled = false;
          btn.textContent = 'üß™ Test Sync';
        }
      };

      // Toast Notification
      function showToast(message, type) {
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.style.borderColor = type === 'success' ? '#22c55e' : '#ef4444';
        toast.innerHTML = `<p style="margin: 0; font-weight: 600;">${message}</p>`;
        document.body.appendChild(toast);

        setTimeout(() => {
          toast.style.opacity = '0';
          toast.style.transform = 'translateX(400px)';
          setTimeout(() => toast.remove(), 300);
        }, 3000);
      }

      fetchData();
      setInterval(fetchData, 5000);
    })();
  </script>
</body>

</html>